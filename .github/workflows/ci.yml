name: CI Pipeline

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  # ------------------------------------------------------------------
  # ETAP 1: Statyczna analiza (Styl, Typy, Bezpieczeństwo)
  # To najszybszy etap. Jeśli tu coś padnie, oszczędzamy czas serwera.
  # ------------------------------------------------------------------
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" # Używamy najnowszej wersji do lintowania
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Instalujemy narzędzia do jakości (spięte wersją z requirements-dev)
          pip install ruff==0.1.6 mypy bandit pip-audit types-requests
          
          # Instalujemy zależności projektu (potrzebne dla mypy, żeby widział typy bibliotek)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Ruff Lint & Format Check
        run: |
          # --check sprawdzi formatowanie bez zmieniania plików (zgłosi błąd)
          ruff format --check .
          ruff check .

      - name: Mypy Static Type Check
        run: mypy .

      - name: Security Checks
        run: |
          # Bandit: szuka luk w kodzie (wykluczamy testy)
          bandit -c pyproject.toml -r . 
          # Pip-audit: szuka luk w zainstalowanych bibliotekach
          pip-audit

  # ------------------------------------------------------------------
  # ETAP 2: Testy Jednostkowe
  # Uruchamiają się TYLKO, gdy 'quality-checks' zakończą się sukcesem.
  # ------------------------------------------------------------------
  unit-tests:
    needs: quality-checks # KLUCZOWE: Czekaj na sukces poprzedniego kroku
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run unit tests with coverage
        # Zachowałem Twoje ustawienia coverage dla src/des
        run: pytest -m "not integration" --cov=src/des --cov-report=term-missing --cov-report=xml

  # ------------------------------------------------------------------
  # ETAP 3: Testy Integracyjne
  # Uruchamiają się TYLKO, gdy testy jednostkowe przejdą.
  # ------------------------------------------------------------------
  integration-tests:
    needs: unit-tests # KLUCZOWE: Czekaj na sukces testów jednostkowych
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11" # Zachowałem Twoją wersję 3.11 dla testów integracyjnych
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      # TODO: Add service setup here if integration tests need Redis/DB/etc.
      # np:
      # - name: Start Redis
      #   uses: supercharge/redis-github-action@1.7.0

      - name: Run integration tests
        run: pytest -m integration
